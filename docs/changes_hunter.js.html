<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: changes_hunter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: changes_hunter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const fs = require("fs-extra");
const CompileState = require('./object_factory').CompileState;

/**
 * For detecting changed patterns.
 * @constructor
 */
const ChangesHunter = function () {
};

ChangesHunter.prototype = {

  /**
   * Checks the build state of a pattern by comparing the modification date of the rendered output
   * file with the {@link Pattern.lastModified}. If the pattern was modified after the last
   * time it has been rendered, it is flagged for rebuilding via {@link CompileState.NEEDS_REBUILD}.
   *
   * @param {Pattern} pattern
   * @param patternlab
   *
   * @see {@link CompileState}
   */
  checkBuildState: function (pattern, patternlab) {

    //write the compiled template to the public patterns directory
    const renderedTemplatePath =
      patternlab.config.paths.public.patterns + pattern.getPatternLink(patternlab, 'rendered');

    //write the compiled template to the public patterns directory
    const markupOnlyPath =
      patternlab.config.paths.public.patterns + pattern.getPatternLink(patternlab, 'markupOnly');

    if (!pattern.compileState) {
      pattern.compileState = CompileState.NEEDS_REBUILD;
    }

    try {

      // renderedTemplatePath required to display a single element
      // Markup only is required for "View All" pages. It will get loaded later on.
      // If any of these is missing, mark pattern for recompile
      [renderedTemplatePath, markupOnlyPath].forEach(renderedFile =>

        // Prevent error message if file does not exist
        fs.accessSync(renderedFile, fs.F_OK)
      );
      const outputLastModified = fs.statSync(renderedTemplatePath).mtime.getTime();

      if (pattern.lastModified &amp;&amp; outputLastModified > pattern.lastModified) {
        pattern.compileState = CompileState.CLEAN;
      }
    } catch (e) {
      // Output does not exist yet, force recompile
      pattern.compileState = CompileState.NEEDS_REBUILD;
    }

    const node = patternlab.graph.node(pattern);

    // Make the pattern known to the PatternGraph and remember its compileState
    if (!node) {
      patternlab.graph.add(pattern);
    } else {
      // Works via object reference, so we directly manipulate the node data here
      node.compileState = pattern.compileState;
    }


  },

  /**
   * Updates {Pattern#lastModified} to the files modification date if the file was modified
   * after {Pattern#lastModified}.
   *
   * @param {Pattern} currentPattern
   * @param {string} file
   */
  checkLastModified: function (currentPattern, file) {
    if (file) {
      try {
        const stat = fs.statSync(file);

        // Needs recompile whenever one of the patterns files (template, json, pseudopatterns) changed
        currentPattern.lastModified =
          Math.max(stat.mtime.getTime(), currentPattern.lastModified || 0);
      } catch (e) {
        // Ignore, not a regular file
      }
    }
  },

  needsRebuild: function (lastModified, p) {
    if (p.compileState !== CompileState.CLEAN || ! p.lastModified) {
      return true;
    }
    return p.lastModified >= lastModified;
  }
};

module.exports = ChangesHunter;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Annotations%2520Exporter.html">Annotations Exporter</a></li></ul><h3>Classes</h3><ul><li><a href="ChangesHunter.html">ChangesHunter</a></li><li><a href="Constructs%2520a%2520new%2520PatternGraph%2520from%2520a%2520JSON-style%2520JavaScript%2520object%2520or%2520an%2520empty%2520graph%250Dif%2520no%2520argument%2520is%2520given..html">Constructs a new PatternGraph from a JSON-style JavaScript object or an empty graphif no argument is given.</a></li><li><a href="Pattern.html">Pattern</a></li><li><a href="PatternRegistry.html">PatternRegistry</a></li><li><a href="VersionMismatch.html">VersionMismatch</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addEdge">addEdge</a></li><li><a href="global.html#addNode">addNode</a></li><li><a href="global.html#buildPatternData">buildPatternData</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#header">header</a></li><li><a href="global.html#initializePlugins">initializePlugins</a></li><li><a href="global.html#installPlugin">installPlugin</a></li><li><a href="global.html#loadDataFromFolder">loadDataFromFolder</a></li><li><a href="global.html#loadFile">loadFile</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#niceKey">niceKey</a></li><li><a href="global.html#PATTERN_GRAPH_VERSION">PATTERN_GRAPH_VERSION</a></li><li><a href="global.html#reportError">reportError</a></li><li><a href="global.html#subGraph">subGraph</a></li><li><a href="global.html#warning">warning</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 17 2017 09:51:21 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
